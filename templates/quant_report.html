{% extends "base.html" %}

{% block title %}í€€íŠ¸ ì¢…í•© ë¦¬í¬íŠ¸ - AskFin{% endblock %}

{% block head %}
<style>
    :root {
        --primary-color: #00aaff;
        --secondary-color: #6c757d;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --info-color: #17a2b8;
        --dark-bg: #212529;
        --card-bg: #2c313a;
        --border-color: #444a50;
        --text-color: #f8f9fa;
        --muted-text-color: #adb5bd;
        --heading-color: #ffffff;
        --box-shadow-medium: 0 0.5rem 1rem rgba(0, 0, 0, 0.35);
    }
    body { background: var(--dark-bg); color: var(--text-color); }
    .report-container {
        padding: 1.5rem;
    }
    .card {
        border: none;
        border-radius: 12px;
        box-shadow: var(--box-shadow-medium);
        background-color: var(--card-bg);
        height: 100%;
    }
    .card-title { font-weight: 600; color: var(--heading-color); }
    .summary-card {
        background: linear-gradient(145deg, #343a40, #2c313a);
        border-left: 5px solid var(--primary-color);
        padding: 1.5rem;
    }
    .summary-value {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
    }
    .risk-label { font-size: 0.9rem; font-weight: 500; }
    .table { color: var(--text-color); }
    .table th { background-color: var(--primary-color); color: #fff; text-align: center; }
    .table-hover tbody tr:hover { background-color: #3a4049; }
    .badge { font-size: 0.85em; padding: 0.5em 0.75em; }
    .list-group-item {
        background-color: transparent;
        border-color: var(--border-color);
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
    }
    .risk-detail-item .risk-name {
        font-weight: 500;
        min-width: 110px;
    }
    .icon-list .list-group-item {
        background-color: var(--dark-bg);
        border-color: var(--border-color);
        display: flex;
        align-items: center;
        margin-bottom: 5px;
        border-radius: 5px;
    }
    .icon-list .list-group-item i {
        margin-right: 10px;
        color: var(--primary-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid report-container">
    <div class="d-flex justify-content-end align-items-center mb-4">
        <span class="text-muted">ë¶„ì„ ê¸°ì¤€ì¼: {{ now.strftime('%Y-%m-%d') }}</span>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-3">í˜„ì¬ ìƒí™© ìš”ì•½</h5>
                    <div class="text-center mb-3">
                        <div class="risk-label text-muted">ì¢…í•© ê²½ì œ ìœ„í—˜ë„</div>
                        <div class="summary-value {% if report.overall_risk > 70 %}text-danger{% elif report.overall_risk > 50 %}text-warning{% elif report.overall_risk > 30 %}text-info{% else %}text-success{% endif %}">
                            {{ "%.1f"|format(report.overall_risk) }}<small>%</small>
                        </div>
                        <div class="risk-label mt-2">
                             {% if report.overall_risk > 70 %}ë§¤ìš° ìœ„í—˜{% elif report.overall_risk > 50 %}ìœ„í—˜{% elif report.overall_risk > 30 %}ì£¼ì˜{% else %}ì•ˆì „{% endif %}
                        </div>
                    </div>
                    <hr style="border-color: var(--border-color);">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between"><span>KOSPI í˜„ì¬ê°€:</span> <strong>{{ "%.2f"|format(report.patterns.technical.current_price) }}</strong></li>
                        <li class="list-group-item d-flex justify-content-between"><span>20ì¼ ì´ë™í‰ê· ì„ :</span> <strong>{{ "%.2f"|format(report.patterns.technical.ma20) }}</strong></li>
                        <li class="list-group-item d-flex justify-content-between"><span>RSI (14ì¼):</span> <strong>{{ "%.2f"|format(report.patterns.technical.rsi) }}</strong></li>
                        <li class="list-group-item d-flex justify-content-between"><span>í˜„ì¬ ë³€ë™ì„±:</span> <strong>{{ "%.1f"|format(report.patterns.technical.volatility) }}%</strong></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-3">ê²½ì œ ìœ„í—˜ë„ ìƒì„¸</h5>
                    {% for risk_type, risk_name in [('inflation', 'ì¸í”Œë ˆì´ì…˜'), ('deflation', 'ë””í”Œë ˆì´ì…˜'), ('stagflation', 'ìŠ¤íƒœê·¸í”Œë ˆì´ì…˜')] %}
                        {% set risk_data = report.current_risks[risk_type] %}
                        {% set future_data = report.future_risks[risk_type] %}
                        {% set risk_level = risk_data.risk %}
                        <ul class="list-group list-group-flush risk-detail-item mb-3">
                            <li class="list-group-item d-flex justify-content-between">
                                <span class="risk-name">{{ risk_name }}</span>
                                <span class="badge 
                                    {% if risk_level >= 80 %}bg-danger{% elif risk_level >= 60 %}bg-warning text-dark{% elif risk_level >= 40 %}bg-info text-dark{% else %}bg-success{% endif %}">
                                    {{ "%.1f"|format(risk_level) }}%
                                </span>
                            </li>
                            <li class="list-group-item"><small>ì£¼ìš” ìš”ì¸: {{ risk_data.factors | join(', ') if risk_data.factors else 'ì—†ìŒ' }}</small></li>
                            <li class="list-group-item"><small>1ì£¼ì¼ í›„ ì˜ˆì¸¡: {{ "%.1f"|format(future_data.predicted) }}% ({{ "%+.1f"|format(future_data.change) }}%)</small></li>
                        </ul>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-3">1ì£¼ì¼ ì‹œì¥ ì˜ˆì¸¡</h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ë‚ ì§œ (ìš”ì¼)</th>
                                    <th>ìƒíƒœ</th>
                                    <th>KOSPI ì˜ˆì¸¡ (ë³€í™”)</th>
                                    <th>KOSDAQ ì˜ˆì¸¡ (ë³€í™”)</th>
                                    <th>ì£¼ìš” ìœ„í—˜ ìš”ì¸</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pred in report.predictions %}
                                <tr>
                                    <td>{{ pred.date }} ({{ pred.weekday }})</td>
                                    <td>
                                        <span class="badge {% if pred.status == 'ê°œì¥' %}bg-success{% else %}bg-secondary{% endif %}">{{ pred.status }}</span>
                                    </td>
                                    {% if pred.status == 'ê°œì¥' %}
                                    <td>
                                        {{ "%.0f"|format(pred.kospi) }}
                                        <span class="small {% if pred.kospi_change > 0 %}text-danger{% else %}text-info{% endif %}">({{ "%+.2f"|format(pred.kospi_change) }}%)</span>
                                    </td>
                                    <td>
                                        {{ "%.0f"|format(pred.kosdaq) }}
                                        <span class="small {% if pred.kospi_change > 0 %}text-danger{% else %}text-info{% endif %}">({{ "%+.2f"|format(pred.kosdaq_change) }}%)</span>
                                    </td>
                                    <td>{{ pred.risk_factors | join(', ') if pred.risk_factors else 'ì•ˆì •' }}</td>
                                    {% else %}
                                    <td colspan="3" class="text-center text-muted">íœ´ì¥</td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-3">ì¢…í•© ê²½ì œ ìœ„í—˜ë„ ë³€í™” ì¶”ì´ (30ì¼ + 1ì£¼ì¼ ì˜ˆì¸¡)</h5>
                    <div style="height: 300px;">
                        <canvas id="riskTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-3">ì£¼ìš” ëª¨ë‹ˆí„°ë§ ì§€í‘œ</h5>
                    <p class="text-muted small">í˜„ì¬ ê²½ì œ ìœ„í—˜ë„ì— ë”°ë¼ ë‹¤ìŒ ì§€í‘œë“¤ì„ ì£¼ì˜ ê¹Šê²Œ ì‚´í´ë³¼ í•„ìš”ê°€ ìˆìŠµë‹ˆë‹¤.</p>
                    <ul class="list-group list-group-flush icon-list">
                        {% for item in report.monitoring_indicators %}
                            <li class="list-group-item">
                                <i class="fas fa-chart-line"></i>
                                {{ item }}
                            </li>
                        {% else %}
                            <li class="list-group-item text-muted">ëª¨ë‹ˆí„°ë§í•  íŠ¹ì • ì§€í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="card summary-card">
                <h4 class="card-title text-primary mb-3">ì¢…í•© íˆ¬ì ì „ëµ ê¶Œì¥ì‚¬í•­</h4>
                {% set risk = report.overall_risk %}
                <p class="fs-5 mb-0">
                    {% if risk > 70 %}
                        ğŸ”´ <strong>ê³ ìœ„í—˜ ìƒí™©:</strong> ì‹œì¥ì˜ ë¶ˆí™•ì‹¤ì„±ì´ ë§¤ìš° ë†’ìŠµë‹ˆë‹¤. í˜„ê¸ˆ ë¹„ì¤‘ì„ 50% ì´ìƒìœ¼ë¡œ í™•ëŒ€í•˜ê³ , ë³€ë™ì„±ì´ ë‚®ì€ ë°©ì–´ì£¼ ì¤‘ì‹¬ìœ¼ë¡œ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ì¬í¸í•˜ëŠ” ë“± ë§¤ìš° ë³´ìˆ˜ì ì¸ ì ‘ê·¼ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
                    {% elif risk > 50 %}
                        ğŸŸ¡ <strong>ì¤‘ìœ„í—˜ ìƒí™©:</strong> ì‹ ì¤‘í•œ íˆ¬ì ì „ëµì´ í•„ìš”í•œ ì‹œì ì…ë‹ˆë‹¤. í˜„ê¸ˆ ë¹„ì¤‘ì„ 30-40% ìˆ˜ì¤€ìœ¼ë¡œ ìœ ì§€í•˜ë©°, ë³€ë™ì„±ì´ í° ìì‚°ì˜ ë¹„ì¤‘ì„ ì¤„ì´ê³  ìš°ëŸ‰ì£¼ ì¤‘ì‹¬ìœ¼ë¡œ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ë‹¤ê°í™”í•˜ëŠ” ê²ƒì´ ì•ˆì •ì ì…ë‹ˆë‹¤.
                    {% elif risk > 30 %}
                        ğŸŸ  <strong>ë³´í†µ ìœ„í—˜:</strong> ê· í˜• ì¡íŒ í¬íŠ¸í´ë¦¬ì˜¤ë¡œ ì‹œì¥ ë³€í™”ì— ëŒ€ì‘í•´ì•¼ í•©ë‹ˆë‹¤. 20-30% ìˆ˜ì¤€ì˜ í˜„ê¸ˆ ë¹„ì¤‘ì„ í™•ë³´í•˜ê³ , ì„±ì¥ì£¼ì™€ ê°€ì¹˜ì£¼ì˜ ë¹„ì¤‘ì„ ì¡°ì ˆí•˜ë©° ì •ê¸°ì ì¸ ë¦¬ë°¸ëŸ°ì‹±ì„ í†µí•´ ìœ„í—˜ì„ ê´€ë¦¬í•˜ëŠ” ì „ëµì„ ì¶”ì²œí•©ë‹ˆë‹¤.
                    {% else %}
                        ğŸŸ¢ <strong>ì €ìœ„í—˜ ìƒí™©:</strong> ì‹œì¥ì´ ì•ˆì •ì ì¸ ìƒíƒœë¡œ, ì ê·¹ì ì¸ íˆ¬ìë¥¼ ê³ ë ¤í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì„±ì¥ì£¼ë‚˜ ì‹œì¥ ì£¼ë„ í…Œë§ˆì— ëŒ€í•œ ë¹„ì¤‘ì„ ì ì§„ì ìœ¼ë¡œ í™•ëŒ€í•˜ê³ , ìœ„í—˜ ìì‚°ì— ëŒ€í•œ íˆ¬ìë¥¼ ê²€í† í•´ë³¼ ìˆ˜ ìˆëŠ” ì‹œê¸°ì…ë‹ˆë‹¤.
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="alert alert-secondary" role="alert">
              <h4 class="alert-heading">ì£¼ì˜ì‚¬í•­</h4>
              <ul class="mb-0">
                  <li>ì´ ë¶„ì„ì€ ê³¼ê±° ë°ì´í„° ê¸°ë°˜ì˜ í†µê³„ ë° AI ëª¨ë¸ ê²°ê³¼ì´ë©°, ë¯¸ë˜ ìˆ˜ìµì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
                  <li>ì˜ˆìƒì¹˜ ëª»í•œ ì´ë²¤íŠ¸(ì§€ì •í•™ì  ë¦¬ìŠ¤í¬, ì •ì±… ë³€í™” ë“±)ëŠ” ì˜ˆì¸¡ì— ë°˜ì˜ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                  <li>ë³¸ ë¦¬í¬íŠ¸ëŠ” íˆ¬ì ê²°ì •ì— ëŒ€í•œ ì°¸ê³  ìë£Œì´ë©°, ì‹¤ì œ íˆ¬ì ì‹œì—ëŠ” ìµœì‹  ë‰´ìŠ¤ì™€ ì¶”ê°€ì ì¸ ë¶„ì„ì´ ë°˜ë“œì‹œ í•„ìš”í•©ë‹ˆë‹¤.</li>
              </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const reportData = {{ report | tojson }};
    const ctx = document.getElementById('riskTrendChart');

    if (ctx && reportData.risk_history && reportData.future_risks) {
        const historyData = reportData.risk_history;
        const futureData = reportData.future_risks;

        const overallHistory = historyData.map(d => 
            (d.inflation * 0.25 + d.deflation * 0.35 + d.stagflation * 0.40)
        );
        const futureOverallRisk = (futureData.inflation.predicted * 0.25 + 
                                   futureData.deflation.predicted * 0.35 + 
                                   futureData.stagflation.predicted * 0.40);

        const labels = historyData.map(d => d.index.substring(5));
        labels.push('1ì£¼ì¼ í›„');

        const overallData = overallHistory;
        overallData.push(futureOverallRisk);

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'ì¢…í•© ê²½ì œ ìœ„í—˜ë„',
                        data: overallData,
                        borderColor: 'rgba(255, 193, 7, 1)',
                        backgroundColor: 'rgba(255, 193, 7, 0.2)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 100, ticks: { color: 'var(--muted-text-color)' }, grid: { color: 'var(--border-color)' } },
                    x: { ticks: { color: 'var(--muted-text-color)', maxRotation: 0, autoSkip: true, maxTicksLimit: 7 }, grid: { color: 'var(--border-color)' } }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        mode: 'index', intersect: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.y !== null) { label += context.parsed.y.toFixed(1) + '%'; }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}