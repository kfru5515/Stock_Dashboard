{% extends "base.html" %}
{% from "macros.html" import render_rank_table with context %}

{% block title %}Dashboard{% endblock %}

{% block head %}
<style>
    .btn-group > .btn.active { background-color: #5cb85c; color: white; border-color: #4cae4c; z-index: 2; }
    .hidden-table { display: none; }
    .chart-wrapper { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px; }
    .chart-container { position: relative; flex: 1 1 250px; min-width: 250px; height: 220px; }
    .chart-header { display: flex; justify-content: space-between; align-items: baseline; }
    .chart-header h3 { margin-bottom: 0; font-size: 18px; }
    .chart-info { font-size: 14px; text-align: right; white-space: nowrap; }
    .chart-info .value { font-weight: bold; font-size: 16px; }
    .chart-info .change { margin-left: 8px; font-size: 13px; }
    .change.positive { color: #d9534f; }
    .change.negative { color: #337ab7; }
    .change.zero { color: #555; }
    /* 상세 정보 모달 내 테이블 스타일 추가 */
    .financial-table { font-size: 14px; }
    .financial-table th, .financial-table td { text-align: right; }
    .financial-table th:first-child, .financial-table td:first-child { text-align: left; background-color: #f8f9fa; }
</style>
{% endblock %}

{% block content %}
<h1>Dashboard</h1>

<div class="chart-wrapper">
    {% if kospi_data and kospi_info.value != 'N/A' %}
    <div class="chart-container">
        <div class="chart-header">
            <h3>KOSPI</h3>
            <div class="chart-info">
                <span id="kospi-value" class="value">{{ kospi_info.value }}</span>
                <span id="kospi-change" class="change {% if kospi_info.raw_change > 0 %}positive{% elif kospi_info.raw_change < 0 %}negative{% else %}zero{% endif %}">
                    {{ kospi_info.change }} ({{ kospi_info.change_pct }})
                </span>
            </div>
        </div>
        <canvas id="kospiChart"></canvas>
    </div>
    {% endif %}
    
    {% if kosdaq_data and kosdaq_info.value != 'N/A' %}
    <div class="chart-container">
        <div class="chart-header">
            <h3>KOSDAQ</h3>
            <div class="chart-info">
                <span id="kosdaq-value" class="value">{{ kosdaq_info.value }}</span>
                <span id="kosdaq-change" class="change {% if kosdaq_info.raw_change > 0 %}positive{% elif kosdaq_info.raw_change < 0 %}negative{% else %}zero{% endif %}">
                    {{ kosdaq_info.change }} ({{ kosdaq_info.change_pct }})
                </span>
            </div>
        </div>
        <canvas id="kosdaqChart"></canvas>
    </div>
    {% endif %}

    {% if usdkrw_data and usdkrw_info.value != 'N/A' %}
    <div class="chart-container">
        <div class="chart-header">
            <h3>USD/KRW</h3>
            <div class="chart-info">
                <span id="usdkrw-value" class="value">{{ usdkrw_info.value }}</span>
                <span id="usdkrw-change" class="change {% if usdkrw_info.raw_change > 0 %}positive{% elif usdkrw_info.raw_change < 0 %}negative{% else %}zero{% endif %}">
                    {{ kospi_info.change }} ({{ usdkrw_info.change_pct }})
                </span>
            </div>
        </div>
        <canvas id="usdkrwChart"></canvas>
    </div>
    {% endif %}

    {% if wti_data and wti_info.value != 'N/A' %}
    <div class="chart-container">
        <div class="chart-header">
            <h3>WTI</h3>
            <div class="chart-info">
                <span id="wti-value" class="value">{{ wti_info.value }}</span>
                <span id="wti-change" class="change {% if wti_info.raw_change > 0 %}positive{% elif wti_info.raw_change < 0 %}negative{% else %}zero{% endif %}">
                    {{ wti_info.change }} ({{ wti_info.change_pct }})
                </span>
            </div>
        </div>
        <canvas id="wtiChart"></canvas>
    </div>
    {% endif %}
</div>

<hr>

<div style="display: flex; gap: 40px; flex-wrap: wrap; margin-top: 20px;">
    {% if kospi_top_volume %}
        {{ render_rank_table('kospi', 'KOSPI', kospi_top_volume, kospi_top_value, today) }}
    {% endif %}
    
    {% if kosdaq_top_volume %}
        {{ render_rank_table('kosdaq', 'KOSDAQ', kosdaq_top_volume, kosdaq_top_value, today) }}
    {% endif %}
</div>

<div class="modal fade" id="stockDetailModal" tabindex="-1" role="dialog" aria-labelledby="stockDetailModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="stockDetailModalLabel">기업 정보</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs" role="tablist">
                    <li role="presentation" class="active"><a href="#news-content" aria-controls="news" role="tab" data-toggle="tab">관련 뉴스</a></li>
                    <li role="presentation"><a href="#profile-content" aria-controls="profile" role="tab" data-toggle="tab">기업 개요</a></li>
                    <li role="presentation"><a href="#reports-content" aria-controls="reports" role="tab" data-toggle="tab">주요 공시</a></li>
                </ul>

                <div class="tab-content" style="padding-top: 20px;">
                    <div role="tabpanel" class="tab-pane active" id="profile-content"></div>
                    <div role="tabpanel" class="tab-pane" id="reports-content"></div>
                    <div role="tabpanel" class="tab-pane" id="news-content"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- 차트 툴팁 옵션을 활성화 ---
    const chartDefaultOptions = { 
        responsive: true, 
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: false } }, 
        plugins: { 
            legend: { display: false },
            tooltip: { // 툴팁 활성화 및 상세 설정
                enabled: true,
                mode: 'index',
                intersect: false,
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) { label += ': '; }
                        if (context.parsed.y !== null) {
                            label += new Intl.NumberFormat('en-US', { style: 'decimal' }).format(context.parsed.y);
                        }
                        return label;
                    }
                }
            }
        }, 
        elements: { point: { radius: 0 }, line: { tension: 0.3, borderWidth: 2 } } 
    };
    
    function parseChartJsData(data) {
        if (!data || !Array.isArray(data)) return { labels: [], closes: [] };
        return { 
            labels: data.map(item => { 
                if (!item.Date) return ''; 
                const parts = item.Date.split('-'); 
                return `${parts[1]}/${parts[2]}`; 
            }), 
            closes: data.map(item => item.Close) 
        }; 
    }

    function createChart(canvasId, chartData, color) {
        const canvas = document.getElementById(canvasId);
        if (canvas && chartData) {
            const parsedData = parseChartJsData(chartData);
            new Chart(canvas, { 
                type: 'line', 
                data: { 
                    labels: parsedData.labels, 
                    datasets: [{ 
                        data: parsedData.closes, 
                        borderColor: color 
                    }] 
                }, 
                options: chartDefaultOptions 
            });
        }
    }

    createChart('kospiChart', {{ kospi_data | tojson }}, 'rgba(54, 162, 235, 1)');
    createChart('kosdaqChart', {{ kosdaq_data | tojson }}, 'rgba(255, 99, 132, 1)');
    createChart('usdkrwChart', {{ usdkrw_data | tojson }}, 'rgba(75, 192, 192, 1)');
    createChart('wtiChart', {{ wti_data | tojson }}, 'rgba(255, 159, 64, 1)');
    
    function updateLatestData() {
        fetch('/api/latest-data')
            .then(response => response.ok ? response.json() : Promise.reject('Network response was not ok.'))
            .then(data => {
                if (data.error) {
                    console.error("Error fetching latest data:", data.error);
                    return;
                }
                function updateIndicator(name, info) {
                    const valueEl = document.getElementById(`${name}-value`);
                    const changeEl = document.getElementById(`${name}-change`);
                    if (!valueEl || !changeEl || !info) return;
                    
                    valueEl.textContent = info.value;
                    changeEl.textContent = `${info.change} (${info.change_pct})`;
                    changeEl.className = 'change';
                    if (info.raw_change > 0) changeEl.classList.add('positive');
                    else if (info.raw_change < 0) changeEl.classList.add('negative');
                    else changeEl.classList.add('zero');
                }
                updateIndicator('kospi', data.kospi);
                updateIndicator('kosdaq', data.kosdaq);
                updateIndicator('usdkrw', data.usdkrw);
                updateIndicator('wti', data.wti);
            })
            .catch(error => console.error("Update fetch error:", error));
    }

    if(document.getElementById('kospi-value')) {
        setInterval(updateLatestData, 30000);
    }

    function setupRankSwitcher(selectorId, titleId, marketPrefix) {
        const selector = document.getElementById(selectorId);
        if (!selector) return;
        selector.addEventListener('click', function(event) {
            if (event.target.tagName !== 'BUTTON') return;
            const targetType = event.target.getAttribute('data-target');
            const title = document.getElementById(titleId);
            const today = "{{ today }}";
            selector.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const volumeTable = document.getElementById(`${marketPrefix}-volume-table`);
            const valueTable = document.getElementById(`${marketPrefix}-value-table`);

            if (targetType === 'volume') {
                volumeTable.classList.remove('hidden-table');
                valueTable.classList.add('hidden-table');
                title.textContent = `${today} ${marketPrefix.toUpperCase()} 거래량 상위 10`;
            } else if (targetType === 'value') {
                volumeTable.classList.add('hidden-table');
                valueTable.classList.remove('hidden-table');
                title.textContent = `${today} ${marketPrefix.toUpperCase()} 거래대금 상위 10`;
            }
        });
    }
    setupRankSwitcher('kospi-rank-selector', 'kospi-rank-title', 'kospi');
    setupRankSwitcher('kosdaq-rank-selector', 'kosdaq-rank-title', 'kosdaq');

    document.body.addEventListener('click', function(event) {
        if (event.target.classList.contains('stock-name')) {
            const stockCode = event.target.getAttribute('data-code');
            const stockName = event.target.textContent.trim();
            
            document.getElementById('stockDetailModalLabel').textContent = `${stockName} (${stockCode})`;
            const spinnerHtml = '<div class="text-center p-4"><div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div></div>';
            document.getElementById('profile-content').innerHTML = spinnerHtml;
            document.getElementById('reports-content').innerHTML = spinnerHtml;
            document.getElementById('news-content').innerHTML = spinnerHtml;
            
            $('#stockDetailModal').modal('show');

            // 1. 기업 프로필 및 DART 공시 목록 가져오기
            fetch(`/askfin/stock/${stockCode}/profile`)
                .then(response => response.ok ? response.json() : Promise.reject('서버 응답 오류'))
                .then(data => {
                    // 기업 개요 탭
                    const profileContent = document.getElementById('profile-content');
                    if (data.profile_error) {
                        profileContent.innerHTML = `<p class="text-danger">오류: ${data.profile_error}</p>`;
                    } else if (data.company_profile) {
                        const profile = data.company_profile;
                        let content = '<dl class="dl-horizontal">';
                        for (const [key, value] of Object.entries(profile)) {
                            content += `<dt>${key}</dt><dd>${value || 'N/A'}</dd>`;
                        }
                        content += '</dl>';
                        profileContent.innerHTML = content;
                    } else {
                        profileContent.innerHTML = `<p class="text-danger">기업 개요 정보를 불러올 수 없습니다.</p>`;
                    }

                    // 주요 공시 탭
                    const reportsContent = document.getElementById('reports-content');
                    if (data.reports_error) {
                        reportsContent.innerHTML = `<p class="text-danger">오류: ${data.reports_error}</p>`;
                    } else if (data.report_list && data.report_list.length > 0) {
                        let reportsHtml = '<ul class="list-group list-group-flush">';
                        data.report_list.forEach(report => {
                            reportsHtml += `<li class="list-group-item">
                                              <a href="${report.url}" target="_blank" rel="noopener noreferrer" style="color: #337ab7;">${report.report_nm}</a>
                                              <small class="d-block text-muted mt-1">${report.flr_nm} - ${report.rcept_dt}</small>
                                            </li>`;
                        });
                        reportsHtml += '</ul>';
                        reportsContent.innerHTML = reportsHtml;
                    } else {
                        reportsContent.innerHTML = '<p class="text-muted text-center p-4">최근 1년간 주요 공시가 없습니다.</p>';
                    }
                })
                .catch(err => {
                    const errorHtml = '<p class="text-danger">정보를 불러오는 데 실패했습니다.</p>';
                    document.getElementById('profile-content').innerHTML = errorHtml;
                    document.getElementById('reports-content').innerHTML = errorHtml;
                });

            // 2. 관련 뉴스 가져오기
            fetch(`/news/${stockCode}`)
                .then(response => response.ok ? response.json() : Promise.reject('Network response was not ok.'))
                .then(data => {
                    const newsContent = document.getElementById('news-content');
                    if (data.error) {
                        newsContent.innerHTML = `<p class="p-3">뉴스를 불러오는 데 실패했습니다: ${data.error}</p>`;
                        return;
                    }
                    if (data.length === 0) {
                         newsContent.innerHTML = `<p class="p-3">관련 뉴스가 없습니다.</p>`;
                         return;
                    }
                    let newsHtml = '<ul class="list-group list-group-flush">';
                    data.forEach(newsItem => {
                        newsHtml += `<li class="list-group-item"><a href="${newsItem.url}" target="_blank" rel="noopener noreferrer" style="color: #337ab7;">${newsItem.title}</a><small class="d-block text-muted mt-1">${newsItem.press} - ${newsItem.date}</small></li>`;
                    });
                    newsHtml += '</ul>';
                    newsContent.innerHTML = newsHtml;
                })
                .catch(error => {
                    document.getElementById('news-content').innerHTML = `<p class="p-3">뉴스를 불러오는 중 오류가 발생했습니다: ${error}</p>`;
                });
        }
    });
});
</script>
{% endblock %}