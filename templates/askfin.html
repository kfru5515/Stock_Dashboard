{% extends "base.html" %}

{% block title %}AskFin - AI 대화형 금융 분석{% endblock %}

{% block head %}
<style>
    #chat-container {
        display: flex;
        flex-direction: column;
        height: 75vh;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background-color: #ffffff;
    }
    #chat-window {
        flex-grow: 1;
        padding: 20px;
        overflow-y: auto;
    }
    .message-row {
        display: flex;
        margin-bottom: 15px;
        width: 100%;
    }
    .message {
        max-width: 80%;
        padding: 12px 18px;
        border-radius: 20px;
        line-height: 1.6;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .user-message-row {
        justify-content: flex-end !important; /* !important로 오른쪽 정렬 강제 */
    }
    .user-message {
        background-color: #007bff;
        color: white;
        border-bottom-right-radius: 5px;
    }

    .ai-message-row {
        justify-content: flex-start !important; /* !important로 왼쪽 정렬 강제 */
    }
    .ai-message {
        background-color: #f1f3f5;
        color: #333;
        border: 1px solid #e9ecef;
        border-bottom-left-radius: 5px;
    }

    #askfin-form-container {
        padding: 15px;
        border-top: 1px solid #e0e0e0;
    }
    #askfin-form {
        display: flex;
        align-items: center;
    }
    #query-input {
        flex-grow: 1;
        font-size: 16px;
        padding: 12px 20px;
        border-radius: 25px;
        border: 1px solid #ccc;
        margin-right: 10px;
    }
    #askfin-form button {
        border-radius: 25px;
        padding: 12px 20px;
        flex-shrink: 0;
    }
    .spinner-container {
        display: none; /* 평소에는 숨김 */
        text-align: center;
        padding: 20px;
    }
    .spinner {
        display: inline-block;
        width: 40px; height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .stock-info-btn { cursor: pointer; color: #0056b3; text-decoration: underline; }
    #pagination-container { margin-top: 15px; text-align: center; }
    .page-btn { margin: 0 5px; padding: 5px 10px; border: 1px solid #ddd; background-color: #fff; cursor: pointer; border-radius: 5px; }
    .page-btn.active { font-weight: bold; background-color: #337ab7; color: #fff; border-color: #337ab7; }
</style>
{% endblock %}

{% block content %}
<h1>AskFin - 대화형 금융 도우미</h1>
<p>금융/투자에 대한 질문을 AI와 대화하듯 물어보세요 ex: 최근 3년동안 가장 많이 오른 제약주는?.</p>
<hr>

<div id="chat-container">
    <div id="chat-window">
        <div class="message-row ai-message-row">
            <div class="message ai-message">안녕하세요! 무엇을 분석해 드릴까요?</div>
        </div>
    </div>
    <div id="loading-spinner-container" class="spinner-container">
        <div class="spinner"></div>
    </div>
    <div id="askfin-form-container">
        <form id="askfin-form" onsubmit="return false;">
            <input type="text" class="form-control" id="query-input" placeholder="질문을 입력하세요...">
            <button type="button" id="submit-btn" class="btn btn-primary">전송</button>
            <button type="button" id="new-chat-btn" class="btn btn-secondary" style="margin-left: 5px;">새 대화</button>
        </form>
    </div>
</div>

<div class="modal fade" id="financialModal" tabindex="-1" role="dialog" aria-labelledby="modal-title-label">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="modal-title-label">기업 개요 정보</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body" id="modal-body">
                <p>정보를 불러오는 중입니다...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- 1. 주요 HTML 요소 가져오기 ---
    const queryInput = document.getElementById('query-input');
    const submitBtn = document.getElementById('submit-btn');
    const chatWindow = document.getElementById('chat-window');
    const newChatBtn = document.getElementById('new-chat-btn');
    const spinnerContainer = document.getElementById('loading-spinner-container');

    let currentQuery = '';
    let currentCacheKey = null;

    // --- 2. 헬퍼 함수 정의 ---
    function addMessageToChat(message, type, contentHtml = null) {
        // 정렬을 담당하는 바깥쪽 div 생성 및 스타일 직접 주입
        const rowDiv = document.createElement('div');
        rowDiv.style.display = 'flex';
        rowDiv.style.marginBottom = '15px';

        // 실제 말풍선 div 생성
        const messageDiv = document.createElement('div');
        
        // --- ▼▼▼ 말풍선 공통 스타일 직접 주입 ▼▼▼ ---
        messageDiv.style.maxWidth = '80%';
        messageDiv.style.padding = '12px 18px';
        messageDiv.style.borderRadius = '20px';
        messageDiv.style.lineHeight = '1.6';
        messageDiv.style.boxShadow = '0 1px 2px rgba(0,0,0,0.1)';
        // --- ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲ ---

        if (type === 'user-message') {
            // --- ▼▼▼ 사용자 말풍선 스타일 직접 주입 ▼▼▼ ---
            rowDiv.style.justifyContent = 'flex-end'; // 오른쪽 정렬
            messageDiv.style.backgroundColor = '#007bff';
            messageDiv.style.color = 'white';
            messageDiv.style.borderBottomRightRadius = '5px';
            // --- ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲ ---
        } else { // ai-message 또는 다른 타입
            // --- ▼▼▼ AI 말풍선 스타일 직접 주입 ▼▼▼ ---
            rowDiv.style.justifyContent = 'flex-start'; // 왼쪽 정렬
            messageDiv.style.backgroundColor = '#f1f3f5';
            messageDiv.style.color = '#333';
            messageDiv.style.border = '1px solid #e9ecef';
            messageDiv.style.borderBottomLeftRadius = '5px';
            // --- ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲ ---
        }
        
        if (contentHtml) {
            messageDiv.innerHTML = contentHtml;
        } else {
            messageDiv.textContent = message;
        }

        rowDiv.appendChild(messageDiv);
        chatWindow.appendChild(rowDiv);

        chatWindow.scrollTop = chatWindow.scrollHeight;
        
        return messageDiv;
    }

    function renderPagination(pagination) {
        let paginationHtml = '<div id="pagination-container">';
        if (pagination && pagination.total_pages > 1) {
            for (let i = 1; i <= pagination.total_pages; i++) {
                const activeClass = (i === pagination.current_page) ? 'active' : '';
                paginationHtml += `<button class="page-btn ${activeClass}" data-page="${i}">${i}</button>`;
            }
        }
        paginationHtml += '</div>';
        return paginationHtml;
    }

    // --- 3. 메인 분석 요청 함수 ---
    function fetchAnalysis(query, page = 1) {
        if (!query) return;
        currentQuery = query;

        if (page === 1) {
            currentCacheKey = null;
            addMessageToChat(query, 'user-message');
            queryInput.value = '';
        }
        
        spinnerContainer.style.display = 'block'; // 스피너 보이기

        fetch("{{ url_for('askfin.analyze_query') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query: query, page: page, cache_key: currentCacheKey })
        })
        .then(response => response.ok ? response.json() : Promise.reject(response))
        .then(data => {
            if (data.cache_key) {
                currentCacheKey = data.cache_key;
            }
            if (data.error) {
                addMessageToChat(`오류: ${data.error}`, 'ai-message');
                return;
            }
            const result = data.result;
            let responseHtml = `<h5>${data.analysis_subject} 분석 결과</h5>`;
            if (Array.isArray(result) && result.length > 0 && typeof result[0] === 'object') {
                const valueLabel = result[0].label || '결과값';
                let table = `<table class="table table-sm table-hover"><thead><tr><th>순위</th><th>종목명</th><th>과거 가격</th><th>현재 가격</th><th>${valueLabel}</th></tr></thead><tbody>`;
                result.forEach((item, index) => {
                    const rank = ((data.pagination.current_page - 1) * 20) + index + 1;
                    const startPrice = item.start_price ? `${parseInt(item.start_price).toLocaleString()} 원` : 'N/A';
                    const endPrice = item.end_price ? `${parseInt(item.end_price).toLocaleString()} 원` : 'N/A';
                    const displayValue = (item.value !== null && item.value !== undefined) ? item.value.toFixed(2) : 'N/A';
                    const valueColor = item.value > 0 ? '#d9534f' : (item.value < 0 ? '#337ab7' : '#333');
                    table += `<tr><td>${rank}</td><td><a href="#" class="stock-info-btn" data-code="${item.code}" data-name="${item.name}">${item.name}</a></td><td>${startPrice}</td><td>${endPrice}</td><td style="color: ${valueLabel.includes('수익률') ? valueColor : '#333'}; font-weight: bold;">${displayValue}</td></tr>`;
                });
                table += `</tbody></table>`;
                responseHtml += table;
                responseHtml += renderPagination(data.pagination);
            } else if (Array.isArray(result) && result.length > 0) {
                responseHtml += `<p>${result.join('<br>')}</p>`;
            }
            addMessageToChat('', 'ai-message', responseHtml);
        })
        .catch(error => {
            addMessageToChat('분석 중 심각한 오류가 발생했습니다. 브라우저의 개발자 콘솔(F12)을 확인해주세요.', 'ai-message');
            console.error('Fetch error:', error);
        })
        .finally(() => {
            spinnerContainer.style.display = 'none'; // 항상 스피너 숨기기
        });
    }

    // --- 4. 이벤트 리스너 설정 ---
    submitBtn.addEventListener('click', () => {
        const query = queryInput.value.trim();
        fetchAnalysis(query, 1);
    });
    queryInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            submitBtn.click();
        }
    });
    newChatBtn.addEventListener('click', () => {
        currentCacheKey = null;
        fetch("{{ url_for('askfin.new_chat') }}", { method: 'POST' })
        .then(() => {
            chatWindow.innerHTML = '';
            addMessageToChat('새로운 대화를 시작합니다. 무엇이 궁금하신가요?', 'ai-message');
        });
    });
    chatWindow.addEventListener('click', (event) => {
        const target = event.target;
        if (target.classList.contains('page-btn')) {
            event.preventDefault();
            const page = parseInt(target.dataset.page, 10);
            fetchAnalysis(currentQuery, page);
        }
        if (target.classList.contains('stock-info-btn')) {
            event.preventDefault();
            const stockCode = target.dataset.code;
            const stockName = target.dataset.name;
            const modalTitle = document.getElementById('modal-title-label');
            const modalBody = document.getElementById('modal-body');

            modalTitle.textContent = `${stockName} (${stockCode}) 기업 개요`;
            modalBody.innerHTML = '<div class="spinner" style="display:block; margin: 20px auto;"></div>';
            
            $('#financialModal').modal('show'); 

            fetch(`/askfin/stock/${stockCode}/profile`)
                .then(response => response.ok ? response.json() : Promise.reject('서버 응답 오류'))
                .then(data => {
                    if (data.error) {
                        modalBody.innerHTML = `<p class="text-danger">오류: ${data.error}</p>`;
                        return;
                    }
                    const profile = data.company_profile;
                    let content = '<dl class="dl-horizontal">';
                    for (const [key, value] of Object.entries(profile)) {
                        content += `<dt>${key}</dt><dd>${value || 'N/A'}</dd>`;
                    }
                    content += '</dl>';
                    modalBody.innerHTML = content;
                })
                .catch(err => {
                    modalBody.innerHTML = '<p class="text-danger">정보를 불러오는 데 실패했습니다.</p>';
                    console.error('Fetch Error:', err);
                });
        }
    });
});
</script>
{% endblock %}