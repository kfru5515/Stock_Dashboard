{% extends "base.html" %}

{% block title %}AskFin(에스크핀){% endblock %}

{% block head %}
<style>
    #results-container { margin-top: 20px; padding: 20px; background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; display: none; }
    .spinner { display: none; margin: 20px auto; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
{% endblock %}

{% block content %}
<h1>AskFin - AI 질문 분석</h1>
<p>분석하고 싶은 질문을 자연어로 입력하세요. (예: 지난 3년간 여름에 가장 많이 오른 제약주는?)</p>
<hr>

<div class="row">
    <div class="col-md-12">
        <form id="askfin-form" class="form-inline">
            <div class="form-group" style="width: 80%;">
                <input type="text" class="form-control" id="query-input" placeholder="질문을 입력하세요..." style="width: 100%;">
            </div>
            <button type="submit" class="btn btn-primary">분석하기</button>
        </form>
    </div>
</div>

<div id="loading-spinner" class="spinner"></div>

<div id="results-container">
    <h3>분석 결과</h3>
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>순위</th>
                <th>종목명</th>
                <th>종목코드</th>
                <th>수익률 (%)</th>
                <th>변동성 (%)</th>
            </tr>
        </thead>
        <tbody id="results-table-body">
            </tbody>
    </table>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('askfin-form');
    const input = document.getElementById('query-input');
    const resultsContainer = document.getElementById('results-container');
    // <pre> 대신 <tbody> 요소를 가져옵니다.
    const tableBody = document.getElementById('results-table-body'); 
    const spinner = document.getElementById('loading-spinner');

    form.addEventListener('submit', function(event) {
        event.preventDefault();
        const query = input.value.trim();
        if (!query) { alert('질문을 입력해주세요.'); return; }

        resultsContainer.style.display = 'none';
        spinner.style.display = 'block';
        tableBody.innerHTML = ''; // 이전 결과 삭제

        const analyzeUrl = "{{ url_for('askfin.analyze_query') }}";

        fetch(analyzeUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query: query })
        })
        .then(response => response.ok ? response.json() : Promise.reject(response))
        .then(data => {
            spinner.style.display = 'none';

            if (data.error) {
                alert(`오류가 발생했습니다: ${data.error}`);
                return;
            }
            
            if (typeof data.result === 'string' || data.result.length === 0) {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 5;
                cell.textContent = data.result[0] || "데이터가 없습니다.";
                cell.style.textAlign = 'center';
            } else {
                data.result.forEach((stock, index) => {
                    const row = tableBody.insertRow();
                    
                    row.insertCell().textContent = index + 1; // 순위
                    row.insertCell().textContent = stock.name;  // 종목명
                    row.insertCell().textContent = stock.code;  // 종목코드
                    
                    const returnCell = row.insertCell();
                    const return_key = stock.average_return_pct !== undefined ? 'average_return_pct' : 'total_return_pct';
                    const returnValue = stock[return_key];
                    returnCell.textContent = `${returnValue.toFixed(2)}`;
                    returnCell.style.color = returnValue > 0 ? '#d9534f' : '#337ab7';
                    returnCell.style.fontWeight = 'bold';
                    
                    row.insertCell().textContent = `${stock.volatility_pct.toFixed(2)}`;
                });
            }
            resultsContainer.style.display = 'block';
        })
        .catch(error => {
            spinner.style.display = 'none';
            alert(`분석 중 심각한 오류가 발생했습니다.`);
            console.error('Fetch error:', error);
        });
    });
});
</script>
{% endblock %}